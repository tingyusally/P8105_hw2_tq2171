---
title: "p8105_hw2_tq2171"
author: "Tingyu Qian"
date: "2024-09-29"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Problem 1

```{r, results='hide'}
# read the package
library(tidyverse) 
library(dplyr)
library(tidyr)
library(readxl)
```


```{r}
## read and clean the data
NYC_Transit = read_csv (file = "./NYC_Transit_Subway_Entrance_And_Exit_Data.csv", na = c("NA", ".")) #read the data
names(NYC_Transit) # see the name of the variables in dataset NYC_Transit
NYC_Transit = janitor::clean_names(NYC_Transit) #clean up variable names after importing data, this will take whatever the column names are and convert them to lower snake case.
names(NYC_Transit) # check the name of the variable about clean
```


```{r}
## retain the needed variables
NYC_Transit<-
  select(NYC_Transit, line, station_name, station_latitude, station_longitude, route1:route11, entry, vending, entrance_type, ada)

```

```{r}
## convert the entry variable from character to a logical variable
NYC_Transit$entry <- ifelse(NYC_Transit$entry == "YES", TRUE, FALSE)
```

In the dataset NYC_Transit, it contains 1868 rows and 32 columns, which means there are 32 variables. These variables are "Division", "Line", "Station Name", "Station Latitude", "Station Longitude", "Route1", "Route2", "Route3", "Route4", "Route5", "Route6", "Route7", "Route8", "Route9", "Route10", "Route11", "Entrance Type", "Entry", "Exit Only", "Vending", "Staffing", "Staff Hours", "ADA", "ADA Notes", "Free Crossover", "North South Street", "East West Street", "Corner", "Entrance Latitude", "Entrance Longitude", "Station Location", "Entrance Location" . For the data cleaning step, I choose to clean up variable names, which is convert all variable names to lower snake case. After that I use the select function to remain the needed variables, which are "line", "station_name", "station_latitude", "station_longitude", "Route1", "Route2", "Route3", "Route4", "Route5", "Route6", "Route7", "Route8", "Route9", "Route10", "Route11", "entry", "vending", "entrance_type" and "ada". The resulting dataset contains 1868 row and 19 columns. These data are tidy, because this dataset satisfied the rules for tidy data, which are: 1. columns are variables 2. Rows are observations and 3. every value has a cell.


```{r}
## distinct stations
distinct_stations <- 
  NYC_Transit %>% 
  distinct(station_name, line) %>%
   summarize(count = n())
print(distinct_stations)
```
There are 465 distinct stations.

```{r}
# Filter for ADA compliant stations (not distinct stations)
ada_compliant_stations_nd <- 
  NYC_Transit %>%
  filter(ada == "TRUE")

# Filter for ADA compliant stations (distinct stations)
ada_compliant_stations_d <- 
  NYC_Transit %>%
  filter(ada == "TRUE") %>%
  distinct(station_name, line)

# Count the number of non_distinct ADA compliant stations
num_nodistinct_ada_compliant_stations <- nrow(ada_compliant_stations_nd)

# Count the number of distinct ADA compliant stations
num_distinct_ada_compliant_stations <- nrow(ada_compliant_stations_d)

print(num_nodistinct_ada_compliant_stations)
print(num_distinct_ada_compliant_stations)
```

For the stations that are ADA compliant, we have 2 situations. One is for distinct stations, the other one is for the whole NYC transit dataset, which we do not find the number of the stations that are ADA compliant based on the distinct stations. For the number of the stations that are ADA compliant based on the non-distinct stations, we have 468 stations, and for the number of the stations that are ADA compliant based on the distinct stations, we have 84 stations.


```{r}
# Calculate the proportion of stations where vending is "NO" (non-distinct stations)
proportion_vending_no_nd <- 
  NYC_Transit %>%
  summarize(proportion = mean(vending == "NO"))

# Calculate the proportion of stations where vending is "NO" (distinct stations)
distinct_stations <- 
  NYC_Transit %>% 
  distinct(station_name, line, .keep_all = TRUE)

proportion_vending_no_d <- 
  distinct_stations %>%
  summarize(proportion = mean(vending == "NO"))

print(proportion_vending_no_nd)
print(proportion_vending_no_d)
```

For the proportion of station entrances/exits without vending allow entrance, we have 2 situations. One is for distinct stations, the other one is for the whole NYC transit dataset, which we do not find the proportion of station entrances/exits without vending allow entrance based on the distinct stations. For the proportion of station entrances/exits without vending allow entrance based on the non-distinct stations, we have 9.796%, and for the proportion of station entrances/exits without vending allow entrance based on the distinct stations, we have 1.935%.


```{r}
NYC_Transit_long <- 
  NYC_Transit %>%
  mutate(across(route1:route11, as.character)) %>%
  pivot_longer(route1:route11, 
               names_to = "route_number", 
               values_to = "route") 

# Filter for stations that serve the A train and get distinct stations
a_train_stations <- NYC_Transit_long %>%
  filter(route == "A") %>%
  distinct(station_name, line, .keep_all = TRUE)

# Count the number of distinct stations that serve the A train
num_a_train_stations <- nrow(a_train_stations)

print(num_a_train_stations)
```
After reformate the data so that route number and route name are distinct variables, there are 60 distinct stations serve the A train. 

```{r}
# Filter for ADA compliant stations among those that serve the A train
ada_compliant_a_train_stations <- a_train_stations %>%
  filter(ada == "TRUE")

# Count the number of ADA compliant A train stations
num_ada_compliant_a_train_stations <- nrow(ada_compliant_a_train_stations)

print(num_ada_compliant_a_train_stations)
```

Of the stations that serve the A train, there are 17 stations have ADA compliant.

## Problem 2
```{r}
# For Mr.Trash Wheel
# Specifying the sheet by name
Mr_Trash_Wheel <- read_excel("./202309 Trash Wheel Collection Data.xlsx", sheet = "Mr. Trash Wheel", skip = 1)

# Rename columns to have reasonable variable names
colnames(Mr_Trash_Wheel) <- c("Dumpster", "Month", "Year", "Date", "Weight_tons", 
                                 "Volume_cubic_yards", "Plastic_Bottles", "Polystyrene", 
                                 "Cigarette_Butts", "Glass_Bottles", "Plastic_Bags", 
                                 "Wrappers", "Sports_Balls", "Homes_Powered", "Notes", "Extra")

# Remove columns containing notes (the last two columns 'Notes' and 'Extra')
Mr_Trash_Wheel <- 
  Mr_Trash_Wheel %>%
  select(-Notes, -Extra)

# Omit rows that do not contain dumpster-specific data (i.e., filter rows with non-NA values in 'Dumpster')
Mr_Trash_Wheel <- Mr_Trash_Wheel %>%
  filter(!is.na(Dumpster))

# Round the number of sports balls to the nearest integer and convert to integer
Mr_Trash_Wheel <- Mr_Trash_Wheel %>%
  mutate(Sports_Balls = as.integer(round(Sports_Balls)))

# View the cleaned data
print(head(Mr_Trash_Wheel))
```

```{r}
# For Professor Trash Wheel
# Specifying the sheet by name
Professor_Trash_Wheel <- read_excel("./202309 Trash Wheel Collection Data.xlsx", sheet = "Professor Trash Wheel", skip = 1)

# Rename columns to have reasonable variable names
colnames(Professor_Trash_Wheel) <- c("Dumpster", "Month", "Year", "Date", "Weight_tons", 
                                 "Volume_cubic_yards", "Plastic_Bottles", "Polystyrene", 
                                 "Cigarette_Butts", "Glass_Bottles", "Plastic_Bags", 
                                 "Wrappers", "Homes_Powered")

# Omit rows that do not contain dumpster-specific data (i.e., filter rows with non-NA values in 'Dumpster')
Professor_Trash_Wheel <- Professor_Trash_Wheel %>%
  filter(!is.na(Dumpster))

# View the cleaned data
print(head(Professor_Trash_Wheel))
```


```{r}
# For Gwynnda Trash Wheel
# Specifying the sheet by name
Gwynnda_Trash_Wheel <- read_excel("./202309 Trash Wheel Collection Data.xlsx", sheet = "Gwynnda Trash Wheel", skip = 1)

# Rename columns to have reasonable variable names
colnames(Gwynnda_Trash_Wheel) <- c("Dumpster", "Month", "Year", "Date", "Weight_tons", 
                                 "Volume_cubic_yards", "Plastic_Bottles", "Polystyrene", 
                                 "Cigarette_Butts","Plastic_Bags", 
                                 "Wrappers", "Homes_Powered")

# Omit rows that do not contain dumpster-specific data (i.e., filter rows with non-NA values in 'Dumpster')
Gwynnda_Trash_Wheel <- Gwynnda_Trash_Wheel %>%
  filter(!is.na(Dumpster))

# View the cleaned data
print(head(Gwynnda_Trash_Wheel))
```

```{r}
# Add the Trash_Wheel column to each dataset to identify the source
Mr_Trash_Wheel <- Mr_Trash_Wheel %>%
  mutate(Trash_Wheel = "Mr. Trash Wheel")

Professor_Trash_Wheel <- Professor_Trash_Wheel %>%
  mutate(Trash_Wheel = "Professor Trash Wheel")

Gwynnda_Trash_Wheel <- Gwynnda_Trash_Wheel %>%
  mutate(Trash_Wheel = "Gwynnda Trash Wheel")
```

```{r}
# Ensure 'Year' is of the same type (e.g., character) in all datasets
Mr_Trash_Wheel <- Mr_Trash_Wheel %>%
  mutate(Year = as.character(Year))

Professor_Trash_Wheel <- Professor_Trash_Wheel %>%
  mutate(Year = as.character(Year))

Gwynnda_Trash_Wheel <- Gwynnda_Trash_Wheel %>%
  mutate(Year = as.character(Year))

# Combine datasets with bind_rows(), filling missing columns with NA
combined_trash_wheel_data <- bind_rows(Mr_Trash_Wheel, Professor_Trash_Wheel, Gwynnda_Trash_Wheel)
```

```{r}
# Filter for Professor Trash Wheel and calculate the total weight
total_weight_professor <- combined_trash_wheel_data %>%
  filter(Trash_Wheel == "Professor Trash Wheel") %>%
  summarize(total_weight = sum(Weight_tons, na.rm = TRUE))
```

```{r}
# Filter the data for Gwynnda Trash Wheel in June 2022 and sum the Cigarette Butts
total_cigarette_butts_gwynnda_june_2022 <- combined_trash_wheel_data %>%
  filter(Trash_Wheel == "Gwynnda Trash Wheel", 
         Month == "June", 
         Year == 2022) %>%
  summarize(total_cigarette_butts = sum(Cigarette_Butts, na.rm = TRUE))
```

After combining three dataset (Mr_Trash_Wheel, Professor_Trash_Wheel, Gwynnda_Trash_Wheel) to one single tidy dataset, we finally have `r nrow(combined_trash_wheel_data)` observations, key variables are like `r names(combined_trash_wheel_data)`. The total weight of trash collected by Professor Trash Wheel is `r total_weight_professor$total_weight` tons. The total number of cigarette butts collected by Gwynnda in June of 2022 is `r total_cigarette_butts_gwynnda_june_2022$total_cigarette_butts`.

## Problem 3

```{r}
# read the dataset bakers, bakes and results
bakers <- read_csv(file = "./gbb_datasets/bakers.csv")
bakes <- read_csv(file = "./gbb_datasets/bakes.csv")
results <- read_csv(file = "./gbb_datasets/results.csv", skip = 2)

# clean up variable names
bakers = janitor::clean_names(bakers)
bakes = janitor::clean_names(bakes)
results = janitor::clean_names(results)
```

```{r}
# Extract first names from the full names in the bakers dataset
bakers <- bakers %>%
  mutate(baker_name = word(baker_name, 1)) 
```


```{r}
# Check if all bakers in results are present in bakers (using first_name)
missing_bakers <- anti_join(results, bakers, by = c("series", "baker" = "baker_name"))
print(missing_bakers)

# Check if all bakes in results are present in bakes
missing_bakes <- anti_join(results, bakes, by = c("series", "episode", "baker"))
print(missing_bakes)

# Exclude rows from results that do not have matching bakers in bakers
results <- results %>%
  anti_join(missing_bakers, by = c("series", "baker"))

# Exclude rows from results that do not have matching bakes in bakes
results <- results %>%
  anti_join(missing_bakes, by = c("series", "episode", "baker"))

# Merge results with bakers and bakes
merged_data <- results %>%
  left_join(bakers, by = c("series", "baker" = "baker_name")) %>%
  left_join(bakes, by = c("series", "episode", "baker"))

# View the merged dataset
head(merged_data)
```

```{r}
# Export the final dataset to a CSV file
write_csv(merged_data, "./final_bake_off_data.csv")
```

